name: Test the Lab 1 of Reuse with pr
on: 
  pull_request:
  workflow_dispatch:
jobs:
  lint-docs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        section: [section1, section2, section3, section4]
      fail-fast: false  # Continue other sections even if one fails

    steps:
      - uses: actions/checkout@v5

      - name: Set directory
        run: |
          echo "DIRECTORY=docs/${{ matrix.section }}" >> $GITHUB_ENV
        shell: bash

      - name: Setup Node.js and install markdownlint
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install markdownlint globally
        run: npm install -g markdownlint-cli

      - name: Print markdownlint version
        run: echo $(markdownlint -V)

      - name: Lint the section markdown
        continue-on-error: true
        run: |
          markdownlint ${{ env.DIRECTORY }}/*.md -o tmp-${{ matrix.section }}.txt
        shell: bash

      - name: Format result
        id: format-result
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const fs = require('fs').promises;
            try {
              var reportBulk = (await fs.readFile("tmp-${{ matrix.section }}.txt")).toString();
            } catch (error) {
              var reportBulk = "No issues found! ‚úÖ";
            }
            const output = `### Lint üìñ - ${{ matrix.section }}
            <details>
            <summary>Click to view linting results</summary>
            
            \`\`\`
            ${reportBulk}
            \`\`\`
            </details>`;
            return output;

      - name: Find Comment
        uses: peter-evans/find-comment@v3
        id: fc
        continue-on-error: true
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: ${{ env.DIRECTORY }}

      - name: Create comment
        if: steps.fc.outputs.comment-id == '' || steps.fc.outcome == 'failure'
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üìÅ ${{ env.DIRECTORY }}
            ${{ steps.format-result.outputs.result }}

      - name: Update comment
        if: steps.fc.outputs.comment-id != '' && steps.fc.outcome != 'failure'
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          body: |
            ## üìÅ ${{ env.DIRECTORY }}
            ${{ steps.format-result.outputs.result }}
          edit-mode: replace

  # Summary job that runs after all sections complete
  lint-summary:
    needs: lint-docs
    runs-on: ubuntu-latest
    if: always()  # Run even if some lint jobs failed

    steps:
      - name: Create summary comment
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üìã Linting Summary Complete
            
            All documentation sections have been linted and individual results are posted above.
            
            - ‚úÖ **section1**: docs/section1
            - ‚úÖ **section2**: docs/section2  
            - ‚úÖ **section3**: docs/section3
            - ‚úÖ **section4**: docs/section4
            
            *This workflow completed at ${{ github.event.head_commit.timestamp }}*
